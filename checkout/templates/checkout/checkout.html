{% extends "base.html" %}
{% load static %}
  
  {% load crispy_forms_tags %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/products.css' %}">
{% endblock %}

{% block extra_title %} | Checkout {% endblock %}

{% block content %}
<div class="container mt-5 pt-5 fade-in-section text-light">
  <h2 class="text-center mb-4">üîÆ Secure Your Order</h2>
  <p class="text-center">Complete your journey into the unknown...</p>

  <div class="row">
    <!-- Checkout form -->
    <div class="col-md-6 mb-4">
      <div class="card bg-dark border-light shadow-lg p-4 h-100">
        <h4 class="mb-3">üßô Your Details</h4>
        <form method="POST" id="payment-form">
          {% csrf_token %}
          {{ form|crispy }}

          <div class="form-group mb-3">
            <label for="card-element">üí≥ Card Details</label>
            <div id="card-element" class="form-control bg-secondary bg-opacity-25 text-light border-light"></div>
          </div>

          <!-- Error messages -->
          <div id="card-errors" role="alert" class="text-danger small mt-2"></div>

          <button type="submit" class="btn btn-own-style w-100 mt-3">
            <i class="fas fa-magic me-2"></i>Place Order
          </button>
        </form>
      </div>
    </div>

    <!-- Order summary -->
    <div class="col-md-6 mb-4">
      <div class="card bg-secondary bg-opacity-10 border-light shadow-lg p-4 h-100">
        <h4 class="mb-3">üõçÔ∏è Your Items</h4>
        {% if bag_items %}
          <ul class="list-group list-group-flush">
            {% for item in bag_items %}
              <li class="list-group-item bg-transparent text-light d-flex justify-content-between align-items-start">
                <div class="d-flex">
                  <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="me-3 rounded" style="width: 60px; height: 60px; object-fit: cover;">
                  <div>
                    <strong>{{ item.product.name }}</strong><br>
                    Qty: {{ item.quantity }}<br>
                    {% if item.is_reading %}
                      <small>{{ item.duration }} min on {{ item.date }} at {{ item.time }}</small>
                    {% endif %}
                  </div>
                </div>
                <div class="text-end">
                  ${{ item.subtotal|floatformat:2 }}
                </div>
              </li>
            {% endfor %}
          </ul>
          <div class="text-end mt-3 fs-5 fw-bold">
            Total: ${{ total|floatformat:2 }}
          </div>
        {% else %}
          <p class="text-warning">Your bag is empty.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe('{{ stripe_public_key }}');
  const elements = stripe.elements();
  const card = elements.create('card', {
    style: {
      base: {
        color: '#ffffff',
        fontFamily: '"Oswald", sans-serif',
        fontSize: '16px',
      },
      invalid: {
        color: '#ff6b6b',
        iconColor: '#ff6b6b'
      }
    }
  });
  card.mount('#card-element');

  const form = document.getElementById('payment-form');
  form.addEventListener('submit', function(ev) {
    ev.preventDefault();
    card.update({ disabled: true });
    stripe.confirmCardPayment('{{ client_secret }}', {
      payment_method: {
        card: card,
        billing_details: {
          name: form.full_name.value,
          email: form.email.value,
          phone: form.phone_number.value,
          address: {
            line1: form.address.value
          }
        }
      }
    }).then(function(result) {
      if (result.error) {
        document.getElementById('card-errors').textContent = result.error.message;
        card.update({ disabled: false });
      } else {
        if (result.paymentIntent.status === 'succeeded') {
          form.submit();
        }
      }
    });
  });
</script>
{% endblock %}
